<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
    <style>
      button {
        padding: 10px;
        outline: none;
        border: none;
        background: #d5f5f5;
      }
    </style>
  </head>
  <body>
    <button id="settingName">update setting name</button>
    <button id="settingAge">update setting age</button>
    <button id="mainName">update main name</button>
    <button id="mainAge">update main age</button>
    <script>
      function mainReducer(
        state = { name: '首页name', age: '首页age' },
        action
      ) {
        const { type, payload } = action
        switch (type) {
          case 'mainName':
            return {
              ...state,
              name: payload
            }
          case 'mainAge':
            return {
              ...state,
              age: payload
            }
          default:
            return state
        }
      }
      function settingReducer(
        state = { name: '设置name', age: '设置age' },
        action
      ) {
        const { type, payload } = action
        switch (type) {
          case 'settingName':
            return {
              ...state,
              name: payload
            }
          case 'settingAge':
            return {
              ...state,
              age: payload
            }
          default:
            return state
        }
      }
      function combineReducers(reducers) {
        let keys = Object.keys(reducers) // 闭包缓存了所有reducers的keys 和 总的reducers对象
        //返回一个reducer传递state和action
        return function(prevState = {}, action) {
          let newState = {}
          for (let i = 0; i < keys.length; i++) {
            let key = keys[i] //拿到每一个key的值
            let itemReducer = reducers[key] //获取对应的reducer
            let prevItem = prevState[key] //找到相对应模块的state
            newState[key] = itemReducer(prevItem, action) // 执行该模块的reducer返回一个该模块的新state
          }
          return newState
        }
      }
      let reducerAll = combineReducers({
        main: mainReducer,
        setting: settingReducer
      })
      // 实现一个createStore
      function createStore(reducer, state = {}) {
        let state_ = state,
          listeners = [] //闭包缓存一个集中state_和订阅队列
        // 获取state_
        function getState() {
          return state_
        }
        // 订阅
        function subscribe(fn) {
          listeners.push(fn)
          // 退订
          return function() {
            let index = listeners.indexOf(fn)
            listeners.splice(index, 1)
          }
        }
        // 更新state_
        function dispatch(action) {
          // 匹配reducer里的规则
          state_ = reducer(state_, action)
          for (let i = 0; i < listeners.length; i++) {
            // 获取每个事件调用
            let itemFn = listeners[i]
            itemFn()
          }
        }
        // 初始化一下state
        dispatch({ type: Symbol() })
        // 暴露出接口
        return {
          getState,
          subscribe,
          dispatch
        }
      }
      // 创建一个state
      store = createStore(reducerAll)
      // 订阅一些方法
      let unSubcribe = store.subscribe(() => {
        let state = store.getState()
        console.log('修改后的state为', state)
      })
      // 10s后退订
      setTimeout(() => {
        console.log('退订啦')
        unSubcribe() //退订
      }, 10000)
      console.log(store.getState())
      // 修改数据方法
      function change(type, payload) {
        store.dispatch({
          type,
          payload
        })
      }

      let settingName = document.getElementById('settingName')
      let settingAge = document.getElementById('settingAge')
      let mainName = document.getElementById('mainName')
      let mainAge = document.getElementById('mainAge')
      settingName.addEventListener('click', () => {
        change('settingName', '修改后的设置name')
      })
      settingAge.addEventListener('click', () => {
        change('settingAge', '修改后的设置age')
      })
      mainName.addEventListener('click', () => {
        change('mainName', '修改后的主页name')
      })
      mainAge.addEventListener('click', () => {
        change('mainAge', '修改后的主页age')
      })
    </script>
  </body>
</html>
